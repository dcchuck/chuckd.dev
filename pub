#!/usr/bin/env python3
import readline  # noqa: F401 - enables keybindings for input()
import re
import sys
from datetime import date
from pathlib import Path

BLOG_DIR = Path(__file__).parent / "src" / "content" / "blog"


def find_drafts():
    drafts = []
    for filepath in BLOG_DIR.glob("*.md"):
        content = filepath.read_text()
        if re.search(r"^draft:\s*true\s*$", content, re.MULTILINE):
            title_match = re.search(r"^title:\s*(.+)$", content, re.MULTILINE)
            title = title_match.group(1).strip() if title_match else filepath.stem
            drafts.append((filepath, title))
    return drafts


def publish(filepath: Path):
    content = filepath.read_text()
    today = date.today().isoformat()

    content = re.sub(r"^draft:\s*true\s*$", "draft: false", content, flags=re.MULTILINE)
    content = re.sub(r"^date:\s*.+$", f"date: {today}", content, flags=re.MULTILINE)

    filepath.write_text(content)


def main():
    drafts = find_drafts()

    if not drafts:
        print("No drafts found")
        return

    print("Drafts:\n")
    for i, (filepath, title) in enumerate(drafts, 1):
        print(f"  {i}. {title} ({filepath.name})")

    print(f"\nSelect: numbers (e.g. 1,3), 'all', or 'cancel'")
    choice = input("> ").strip().lower()

    if choice == "cancel" or not choice:
        print("Cancelled")
        return

    if choice == "all":
        selected = list(range(len(drafts)))
    else:
        try:
            selected = [int(x.strip()) - 1 for x in choice.split(",")]
            if any(i < 0 or i >= len(drafts) for i in selected):
                print("Invalid selection")
                return
        except ValueError:
            print("Invalid input")
            return

    for i in selected:
        filepath, title = drafts[i]
        publish(filepath)
        print(f"Published: {title}")


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        sys.exit(1)
